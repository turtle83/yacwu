<html ng-app="myApp" ng-controller="MainCtrl">
<head>
	<title>Cgminer controler</title>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.6/angular.min.js"></script>
</head>
<body>
	<h1>Hello World!</h1>
	Updated : {{refreshed| date:'medium'}}
	<button ng-click='reload_all()'>Reload</button>
	<h3>Summary</h3>
	{{summary_status.When * 1000 | date:'medium'}} {{summary_status.Description}} started 
	{{summary_global.Elapsed}} seconds ago.
	<table>
		<tr>
			<th>ID</th>
			<th>Accepted</th>
			<th>Rejected</th>
			<th>Best Share</th>
			<th>Last Share time</th>
			<th>URL</th>
		</tr>
		<tr ng-repeat="pool in pools">
			<td>{{pool.POOL}}</td>
			<td>{{pool.Accepted}}</td>
			<td>{{pool.Rejected}}</td>
			<td>{{pool["Best Share"]}}</td>
			<td>{{pool["Last Share Time"] * 1000| date:'medium'}}</td>
			<td>{{pool.URL}}</td>
		</tr>
	</table>
	<table>
		<tr>
			<th>ID</th>
			<th>Name</th>
			<th>Enabled</th>
			<th>Hash 5s</th>
			<th>Hash avg</th>
			<th>Last Share</th>
			<th>Accepted</th>
			<th>Rejected</th>
			<th>HW err</th>
		</tr>
		<tr ng-click='showdevdetails = !showdevdetails'>
			<th>All</th>
			<th>Summary</th>
			<th>???</th>
			<th>???</th>
			<th>{{summary_global["MHS av"]}} MH/s</th>
			<th>{{summary_global["Last Share Time"] * 1000 | date:'medium'}}</th>
			<th>{{summary_global.Accepted}}</th>
			<th>{{summary_global.Rejected}}</th>
			<th>{{summary_global["Hardware Errors"]}} ({{summary_global["Hardware Errors"]/ (summary_global.Accepted + summary_global.Rejected) * 100 |number }}%)</th>
		</tr>
		<tr ng-repeat='dev in devs' ng-show='showdevdetails'>
			<td>{{dev.ID}} </td>
			<td>{{dev.Name}}</td>
			<td>{{dev.Enabled}}</td>
			<td>{{dev["MHS 5s"]}} MH/s</td>
			<td>{{dev["MHS av"]}} MH/s</td>
			<td>{{dev["Last Share Time"] * 1000 | date:'medium'}}</td>
			<td>{{dev.Accepted}}</td>
			<td>{{dev.Rejected}}</td>
			<td>{{dev["Hardware Errors"]}} ({{dev["Hardware Errors"]/ (dev.Accepted + dev.Rejected) * 100 |number }}%)</td>
		</tr>
	</table>


<script>
angular.module('myApp',[ ])

function MainCtrl($scope, $http, $timeout ){
	$scope.pools = [];
	$scope.pools_status = {};
	$scope.devs = [];
	$scope.devs_status = {};
	$scope.refreshed = null;
	$scope.showdevdetails = false;

	$scope.reload_pools = function(){
		$http.get("/api/pools/").success(function(data){
			$scope.pools = data["POOLS"]
			$scope.pools_status = data["STATUS"][0]
		});
	}

	$scope.reload_devs = function(){
		$http.get("/api/devs/").success(function(data){
			$scope.devs = data["DEVS"]
			$scope.devs_status = data["STATUS"][0]
		});
	}

	$scope.reload_summary = function(){
		$http.get("/api/summary/").success(function(data){
			var last_share = 0;
			$scope.summary_global = data["SUMMARY"][0]
			$scope.summary_status = data["STATUS"][0]
			//Get last share from devs
			$scope.devs.forEach(function(dev){
				if (dev["Last Share Time"] > last_share){
					last_share = dev["Last Share Time"];
				}
			});
			$scope.summary_global["Last Share Time"] = last_share;
		});
	}

	$scope.reload_all = function(){
		$scope.reload_pools();
		$scope.reload_devs();
		$scope.reload_summary();
		$scope.refreshed = new Date();
	}

	$scope.reload_all();

	$timeout(function updater(){
		$scope.reload_all();
		$timeout(updater, 10000);
	},1000);
}
</script>

</body>
</html>